## 1. создать свой RPM (можно взять свое приложение, либо собрать к примеру апач с определенными опциями)
Устанавливаем `yum install rpm-build rpmdevtools -y` чтобы иметь возможность компилировать, сжимать и расжимать архивные контейнеры cpio + gzip как сжатие. Также ставим rpmdevtools для экономии времени используется создание иерархии каталогов `rpmdev-setuptree` и `rpmdev-newspec -r 3.11 httpd.spec` шаблоны SPEC файла:
```
~/rpmbuild
|-- BUILD
|-- BUILDROOT
|-- RPMS
|   |-- i386
|   |-- i586
|   |-- x86_64
|   `-- noarch
|-- SOURCES
|-- SPECS
`-- SRPMS
```
noarch, пакет в котором нет бинарников

BUILDROOT - здась осуществляется сборка возможно можно прокинуть симлинком ramfs либо tmpfs для быстродействия io

RPMS - здесь появятся бинарные пакеты, подкаталоги создаются автоматически во время сборки в зависимости от архитектуры

SRPMS - здесь появится исходники

SOURCES и SPECS - исходники и патчи должны лежать в каталоге SOURCES, а spec файл в каталог SPECS затем собираем `rpmbuild -ba httpd.spec`
Если необходимо собрать только бинарник или только исходник, то вместо `-ba` следует использовать `-bb` и `-bs` соответственно, `-clean` - удалить весь мусор, `-rmsource` - удалить исходники из каталога SOURCE и -target=архитектура (собрать пакет под конкретную архитектуру).
![rpmbuild](https://github.com/kyourselfer/OTUS_LinuxAdmin201804/blob/master/lesson8_rpm/img/rpmbuild.gif)

Для того чтобы извлечь из бинарного сжатого архива rpm используем `rpm2cpio httpd24-httpd-2.4.27-8.el7.1.src.rpm | cpio -idmv` таким образом можно взять готовый spec файл из архива с исходниками httpd24-httpd-2.4.27-8.el7.1.src.rpm.

`rpmrebuild` - используем если пакет уже установлен в системе и если хочется получить готовый rpm с ним, с изменёнными под нужды конфигурационными файлами. Можно также изменять release пакета, changelog, скрипты, секции Requires, описания пакета и т.д.

### [SPEC файл](https://github.com/kyourselfer/OTUS_LinuxAdmin201804/blob/master/lesson8_rpm/1/httpd.spec)

![file.spec](https://github.com/kyourselfer/OTUS_LinuxAdmin201804/blob/master/lesson8_rpm/img/file.spec.gif)
Source: - исходные тексты, тарболы и др. файлы.

Patch: - патчи, исправления, которые выпустили для данного пакета. Не принято изменять исходный текст самой программы, а затем завертывать ее в тарбол. Принято накладывать заплатки. Распаковываем исходный тарбол, у нас это будет httpd-2.4.34.tar.bz2, далее копируете httpd-2.4.34 в httpd-2.4.34.orig. После этого изменяете код в каталоге httpd-2.4.34, выходите из него и отдаете команду diff -ur httpd-2.4.34.orig httpd-2.4.34 > httpd-2.4.34.tar.bz2-name_of_patch.patch. Как видно, до навания патча идёт %{name}-%{version} пакета. В самом spec-файле обязательно следует писать название патча без макроопределений. По крайней мере версию, точно. Иначе при обновлении версии пакета, у вас и обновится версия патча, определённая макросом %{version}, а патч может быть подойдёт к новой версии программы и без каких либо изменений. Если же во время самой сборки патч не смог наложиться, то его следует либо переделать под данную версию программы, либо отключить в секции %setup.

BuildRequires: - секция, в которую через запятую или через пробел прописываются пакеты, которые требуются для сборки нашей программы.

Requires: - в эту секцию записываются пакеты или файлы(!), которые будет требовать данный пакет при установке. При сборке в зависимости автоматически пропишутся все библиотеки, которые наш пакет потребует, но вы также можете указать пакеты вручную. Rpm также автоматически прописывает зависимости perl, python, mono и некоторые другие (все эти зависимости прописываются не в spec-файл разумеется, а в сам пакет). 

Obsoletes: - удаление указанных пакетов при установки текущего пакета. Как бы говорится, что данный пакет замещает собой указанные (по функциональности, по набору файлов), Можно использовать конструкцию название <.

Conflicts: - перечисляются пакеты, которые конфликтуют с текущим. Подразумевается что указанные пакеты нужно вручную удалить, перед установкой нашего. Можно использовать конструкцию название <.

Epoch: - используется для приоритета перед более новыми версиями пакета (допустим имеет версию 2.4.27, а также есть более старый 2.4.26. Так вот если %{epoch} у httpd 2.4.26 будет 1, а у 2.4.27 - 0, то пакет 2.4.26 будет всегда новее, чем 2.4.27. О чём при установки вам RPM и скажет. Этот параметр удобен, если вы хотите откатиться на предыдущую версию).

%prep в ней начинается подготовка к сборке.

%setup здесь распаковывает исходники. Опция -q не показывает вывод распаковывания архива. Опция -a1 используется для распаковки %{SOURCE1} , второго тарбола внутрь(!) каталога первого тарбола. Соответственно цифра указывает на номер SOURCE. Если у вас первый каталог в тарболе имеет отличное от %{name}-%{version} название, то rpm не сможет войти автоматом в этот каталог.

%files здесь нужно указать какие файлы должны быть упакованы в пакеты. Все файлы должны быть оговорены, в противном случае rpmbuild выдаст сообщение о неупакованных файлах, -f указываются файл, содержащий список обрабатываемых файлов.

%build здесь происходит сборка пакета. 

### Макроопределения

%define date 20180915 - переменная задается в виде %{date} (скобки'{}' не обязательны)
```
%if 0%{?rhel} >= 7
%define vstring %(source /etc/os-release; echo ${REDHAT_SUPPORT_PRODUCT})
%else
%define vstring centos
%endif
```
Для определения каталогов используются специальные макроопределения:
```
%{_prefix} - /usr
%{_sysconfdir} - /etc
%{_bindir} - /usr/bin
%{_datadir} - /usr/share
%{_libdir} - /usr/lib или /usr/lib64 в зависимости от разрядности системы
%{_lib} - соответственно /lib или /lib64
%{_libexecdir} - /usr/libexec
%{_includedir} - /usr/unclude
%{_mandir} - /usr/share/man
%{_sbindir} - /usr/sbin
%{_localstatedir} - /var.
%{systemd_libdir} - /usr/lib/systemd
```
%define date 20180915 - Теперь в любом месте spec-файла мы можем использовать нашу переменную в виде %{date} (скобки'{}' не обязательны)
```
%if 0%{?rhel} >= 7
%define vstring %(source /etc/os-release; echo ${REDHAT_SUPPORT_PRODUCT})
%else
%define vstring centos
%endif
```
Внутри всех секций spec-файла мы можем использовать любые команды Linux, без каких либо «наворотов», а вот в шапке файла не всё так просто. Внешняя команда выполняется в %() (как в bash - $()) и в spec-файле необходимо ставить два знака % в параметрах.
```
Requires:       apr = %(rpm -q apr --qf "%%{version}")
```
%doc помечает файлы как документацию. Третья строка копирует указанные файлы в каталог %{_datadir}/doc/%{name}-%{version} . По умолчанию файлы в rpm пакете будут иметь владельцем root’а, а права доступа у низ будут такие же, как и в процессе установки. Если это необходимо поменять, то воспользуйтсь конструкцией %defattr.

### Usefull
Для поиска нужной готовой сборки используются ресурсы:
rpmfind.net, rpm.pbone.net и pkgs.org

Нельзя собирать из под root т.к. есть вероятность, что корнем для секции инсталляции окажется каталог / и тогда команда rm -rf %{buildroot}
